<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>MTBA Bus Locations</title>

	<script src="https://api.mapbox.com/mapbox-gl-js/v1.11.0/mapbox-gl.js"></script>
	<link href="https://api.mapbox.com/mapbox-gl-js/v1.11.0/mapbox-gl.css" rel="stylesheet" />
	<style>
		body { margin: 0; padding: 0; }
		#map { position: absolute; top: 0; bottom: 0; width: 100%; }
		.map-overlay {
		  position: absolute;
		  left: 0;
		  padding: 10px;
	  }

	  .marker {
		background-image: url('./media/bus.svg');
		background-size: cover;
		width: 50px;
		height: 50px;
		border-radius: 50%;
		cursor: pointer;
}
	  
	  </style>
</head>
<body>
	<div id="map"></div>

</body>
</html>


<script>

mapboxgl.accessToken = 'pk.eyJ1IjoiaW50dXRlY2lvIiwiYSI6ImNsMnhqa3FnZDA3OWUzam8wd3RyaHJnMjQifQ.BSfbphgu9dm2g8czPVJC9g';

const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v11',
    center: [-71.104081,42.365554],
    zoom: 14
});

var current_location = ''
var counter = 0;
var marker = '';
const Icon = '../media/bus.svg';

async function run(){

    // get bus data    
	const locations = await getBusLocations();
	console.log(new Date());
	console.log(locations);

	current_location = locations;

	let lat = current_location[0]['attributes']['latitude'];
	let lng = current_location[0]['attributes']['longitude'];


	if ( counter === 0 ) {
		//add initial marker

			// marker = new mapboxgl.Marker()
			// .setLngLat([lng,lat])
			// .addTo(map)
		//   .bindPopup(title);

		var geojson = {
		type: 'FeatureCollection',
		features: [
			{
			type: 'Feature',
			geometry: {
				type: 'Point',
				coordinates: [lng,lat]
			},
			properties: {
				title: 'Mapbox',
				description: 'Washington, D.C.'
			}
			}			
  		]
		};

		// add markers to map
		for (const feature of geojson.features) {
		// create a HTML element for each feature
		const el = document.createElement('div');
		el.className = 'marker';

		// make a marker for each feature and add to the map
		new mapboxgl.Marker(el).setLngLat(feature.geometry.coordinates).addTo(map);
		}

	} else {

		Marker.setLngLat([lng, lat]);
	
	}

	map.setCenter ([lng, lat])
	counter ++;

	// timer
	setTimeout(run, 5000);
}

// Request bus data from MBTA
async function getBusLocations(){
	const url = 'https://api-v3.mbta.com/vehicles?filter[route]=1&include=trip';
	const response = await fetch(url);
	const json     = await response.json();
	return json.data;
}

run();

</script>